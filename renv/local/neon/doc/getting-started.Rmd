---
title: "Getting Started"
output: 
  rmarkdown::html_vignette
editor_options:
  chunk_output_type: console
vignette: >
  %\VignetteIndexEntry{getting-started}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
---

<style>
body, h1, h2, h3, h4 {
    font-family: "Roboto";
}
</style>

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

The `neon` package serves as an R wrapper for the Smartabase API. At present, the package consists of two primary functions: `pull_smartabase()` for downloading Smartabase data into R and `push_smartabase()` for uploading data from R up to Smartabase. 

This quick start guide will get you up and running with the three main functions of `neon`

  * [save_credentials()](#save_credentials)
  * [pull_smartabase()](#pull_smartabase)
  * [push_smartabase()](#push_smartabase)

### Load neon

Load the `neon` package
```{r load-package, eval = FALSE}
library(neon)
```

### Save your Smartabase credentials across R sessions {#save_credentials}

In order to push and pull data to and from Smartabase, you need to provide credentials. This means that you will only be allowed to access data that your permissions allow. The credentials you need are

* `username`
    + Smartabase username
* `password`
    + Smartabase password
* `entered_by_user_id`
    + Unique Smartabase ID of person uploading data to Smartabase
    + Look in your administration account or ask your system administrator.
* `url`
    + Smartabase url
    + e.g. "example.smartabase.com/site"

There are three general approaches to supplying your credentials to the Smartabase API

1. (default) Setup `username`, `password`, `entered_by_user_id` and `url` via `save_credentials()` -- this only has to be done once
2. Trigger a masked password pop-up input by setting setting `password = "prompt"` within `pull_smartabase()` / `push_smartabase()`
3. Manually type all credentials within each in `pull_smartabase()` / `push_smartabase()` call (or you could supply some of the credentials in the API calls, and save others using `save_credentials()`).

The first method is the most convenient but also means that your credentials are stored as plain text in a hidden file called `.Renviron`.

**You need to make sure you never share the .Renviron file and understand the risks of not encrypting your Smartabase login credentials**. 

#### Using save_credentials()
Run `save_credentials()` to store your credentials

```{r credentials, eval = FALSE}
save_credentials()
```

This will launch the `.Renviron` file where you can store your Smartabase credentials. See the instructions in the console to store your username, password and/or user ID.

```{r credentials-output, echo = FALSE, eval = FALSE}
neon::save_credentials()
```

### Pulling data from Smartabase {#pull_smartabase}
Pulling Smartabase data with `neon` is easy with the `pull_smartabase()` function. If we assume your credentials are already saved using `save_credentials()`, you will at a minimum still need to supply values to the `form`, `start_date` and `end_date` arguments. Note that `start_date` and `end_date` must be in 'dd/mm/yyyy' format

```{r pull_example1, eval = FALSE}
training_data <- pull_smartabase(
  form       = "Training Log",
  start_date = "15/04/2019",
  end_date   = "15/04/2019"
)
```

If we had not stored any credentials using `save_credentials()`, the API call may look more like this

```{r pull_example2, eval = FALSE}
training_data <- pull_smartabase(
  form       = "Training Log",
  url        = "example.smartabase.com/site",
  username   = "zac.pross",
  password   = "examplePassword",
  start_date = "15/04/2019",
  end_date   = "15/04/2019"
)
```

```{r pull_success, echo = FALSE}
cat("User ID data is downloading...")
cat("|===================================================================| 100%")
message("Authentication success: (200) ok")
message("Training Log download successful")
```

A successful download! We have training data for two athletes named Aiden Thomas and Jamie Anderson

```{r fake_data, echo = FALSE, paged.print = TRUE}
training_data <- dplyr::tibble(
  date               = "15/04/2019",
  user_id            = c(37204, 37201),
  about              = c("Aiden Thomas", "Jamie Anderson"),
  distance           = c(2530, 5411),
  RPE                = c(5, 7),
  event_id           = c(2381840, 2382033),
  entered_by_user_id = c(37204, 37201)
)

training_data
```

**A quick note**, constantly pulling data from your Smartabase site can put stress on the server, affecting your organisation's Smartabase experience. At a minimum, please save your pulled data to a variable (here we saved it to a variable called "training_data"). This minimises unnecessary API calls. 

If you are pulling especially large datasets that are not being updated regularly, save your pulled data to an RDS file so that it persists across R sessions. For example,

```{r save_rds, eval = FALSE}
# Save data onto local machine using saveRDS
saveRDS(training_data, "training_data")

# Load it back in again using readRDS
readRDS("training_data")
```

## Pushing data to Smartabase {#push_smartabase}
Let's say we now want do some calculations on our Training Log data and then push the results back up to Smartabase.

We want to calculate the difference between each athlete's RPE and the team average RPE. We'll then upload the results to a form called "Team Summary"

```{r avg_RPE, message = FALSE}
# Need to load dplyr
library(dplyr)

RPE_average <- training_data %>% 
  select(-entered_by_user_id) %>% 
  mutate(team_RPE = round(mean(RPE), 1))

RPE_average
```

Now we can compare the group average to each athlete's RPE on each day

```{r}
RPE_average <- RPE_average %>%
  mutate(RPE_diff = RPE - team_RPE)

RPE_average
```

If we want to upload our results back up to Smartabase, and assuming again that we have setup our credentials using `save_credentials()`, at a minimum we now need to provide `push_smartabase()` with our dataframe (`RPE_average`) and the name of the Smartabase form we are uploading to ("Team Summary").

```{r push_RPE, eval = FALSE}
push_smartabase(
  df   = RPE_average,
  form = "Team Summary"
)
```

```{r push_RPE_success, echo = FALSE}
cat("Uploading 1 rows to Team Summary...") 
cat("|===================================================================| 100%")
message("Authentication success: (200) ok")
message("SUCCESSFULLY_IMPORTED: 4 out of 4 records successfully imported")
```

Success! Our data should be uploaded to the "Team Summary" form on Smartabase.

Of course, this is a trivial example. We are excited to see how `neon` can help our clients integrate the powerful machine learning and statistical modelling capabilities of R with their Smartabase workflows.

To learn more about how to get the most out of `pull_smartabase()` and `push_smartabase()`, please see the `pulling-data` and `pushing-data` vignettes.
