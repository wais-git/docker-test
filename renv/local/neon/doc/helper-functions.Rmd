---
title: "Helpers: A Detailed Guide"
output: 
  rmarkdown::html_vignette
editor_options:
  chunk_output_type: console
vignette: >
  %\VignetteIndexEntry{helper-functions}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
---

<style>
body, h1, h2, h3, h4 {
    font-family: "Roboto";
}
</style>

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

If you haven't already, please read the `installing-neon`, `getting-started`, `pulling-data` and `pushing-data` vignettes before proceeding. You can view them in a browser by typing `browseVignettes("neon")` or in RStudio with `vignette(<name_of_vignette>, package = "neon")`.

`neon` contains several helper functions that are called within `pull_smartabase()` and `push_smartabase()` that may be of use to our users; namely, `get_group()` and `get_id()`. This vignette will explain what these functions do and how they can be used.

  * [get_group](#get_group)
  * [get_id](#get_id)
  * [get_metadata_names](#get_metadata_names)
  
### get_group() {#get_group}

`get_group()` returns a list of Smartabase groups available to your account. It's arguments are `username`, `password` and `url`. If you have already saved your credentials using `save_credentials()`, you can just call `get_group()` without any arguments

```{r, get_group, eval = FALSE}
get_group()
```

```{r get_group_print, echo = FALSE}
groups_df <- dplyr::tibble(
  Group = c("All Users", "First Team", "Reserves")
)

groups_df
```

Alternatively, you could supply the arguments manually

```{r get_group_manual, eval = FALSE}
get_group(
  username = "john.smith",
  password = "examplePassword",
  url      = "example.smartabase.com/site"
)
```

How is this useful? `get_group()` helps you remember the names of the groups you have access to, which you can then supply to the `filter_data_value` argument in `pull_smartabase()` (see `vignette("pulling-data", package = "neon")`); like so 

```{r pull_group, eval = FALSE}
pull_smartabase(
  form              = "Training Log",
  filter_data_key   = "group",
  filter_data_value = "First Team"
)
```

This would only return data for athletes in the "First Team" group.

### get_id() {#get_id}

`get_id()` returns the user IDs, emails and usernames for specific athletes. Set `get_uuid = TRUE` to return Smartabase UUID, which is an ID that can be set on the Smartabase admin site. 

Similar to `pull_smartabase()`, you can nominate which athletes you would like user IDs returned for by supplying values to the `filter_user_key` and `filter_user_value` arguments. 

Why is `get_id()` useful? Recall that the Smartabase API requires athletes' user IDs when uploading to Smartabase with `push_smartabase()` (see `vignette("pushing-data-guide", package = "neon")`). `get_id()` is just one way to find your athletes' user IDs for use with `push_smartabase()`.

#### filter_user_key options

The examples below assume you have set up your credentials using `save_credentials()`.

**current_group**

The API will look for whatever Smartabase group was loaded when last logged into Smartabase. User IDs will only be pulled for these users. `filter_user_value` is ignored.

```{r current_group_example, eval = FALSE}
get_id(
  filter_user_key = "current_group"
  )
```

The resulting dataframe will look something like this

```{r current_group_data, echo = FALSE}
dplyr::tibble(
  user_id  = c(37204, 37201),
  about    = c("Aiden Thomas", "Jamie Anderson"),
  email    = c("aiden.thomas@fusionsport.com", "jamie.anderson@fusionsport.com"),
  username = c("aiden.thomas", "jamie.anderson")
)
```

**group**

User IDs will only be pulled for athletes in specific Smartabase groups. You must supply the name/s of the group/s in the `filter_user_value` argument

```{r group_example, eval = FALSE}
get_id(
  filter_user_key   = "group",
  filter_user_value = "First Team"
  )
```

**about**

User IDs will only be pulled for athletes whose full names match the values supplied in `filter_user_value`

```{r about_example, eval = FALSE}
get_id(
  filter_user_key   = "about",
  filter_user_value = c("Aiden Thomas", "Jamie Anderson")
  )
```

**username**

User IDs will only be pulled for athletes whose Smartabase usernames match the values supplied in `filter_user_value`

```{r username_example, eval = FALSE}
get_id(
  filter_user_key   = "username",
  filter_user_value = c("aiden.thomas", "jamie.anderson")
  )
```

**email**

User IDs will only be pulled for athletes whose Smartabase emails match the values supplied in `filter_user_value`

```{r email_example, eval = FALSE}
pull_smartabase(
  form              = "Example event form",
  filter_user_key   = "email",
  filter_user_value = c("aiden.thomas@fusionsport.com", "jamie.anderson@fusionsport.com")
  )
```

### get_metadata_names() {#get_metadata_names}

Once data has been pulled in from Smartabase, it is often desirable to retain the metadata variables (e.g. about, start_time etc.) in the data frame before pushing back to Smartabase. Rather than having to repeatedly write out the vector of metadata variables you want to retain (e.g. `{r, eval = FALSE} example_df %>% select(c("about", "user_id", "start_date", "end_date", "start_time", "end_time"), everything())`), this helper function will look for any metadata variables present in a dataframe and return them.

```{r get_metadata_names_example, eval = FALSE}
example_df <- dplyr::tibble(
  about = c("Jamie Anderson", "Charlie Thompson"),
  start_date = c("14/02/2020", "14/02/2020"),
  form = "Hydration",
  `Body Weight pre training` = round(runif(2, 82, 92), 0),
  `Body Weight post training` = round(runif(2, 82, 92), 0),
  `Urine Colour` = round(runif(2, 1, 8), 0),
  end_date = c("14/02/2020", "14/02/2020")
)

example_df %>% dplyr::select(get_metadata_names(.))
```

```{r get_metadata_names3, echo = FALSE}
dplyr::tibble(about = c("Jamie Anderson", "Charlie Thompson"),
       form = c("Hydration", "Hydration"),
       start_date = c("14/02/2020", "14/02/2020"),
       end_date = c("14/02/2020", "14/02/2020"))
```
